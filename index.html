<!DOCTYPE html>
<html>

<head>
  <title>Token Snap!</title>
  <link rel="icon" type="image/svg" href="./images/icon.svg" />
  <link rel="stylesheet" href="index.css">
</head>

<body>
  <div class="main">
    <h1>Token Snap</h1>

    <h2> Get the price and check the compliance of a token with just a click ðŸ˜‰</h2>
    <details>
      <summary>Instructions</summary>
      <ul>
        <li>First, click "Connect", to connect your metamask flask!</li>
        <li>Please note that:</li>
        <ul>
          <li>
            You must have the metamask flask extension installed on your browser
          </li>
          <li>
            Enter two different token address, and press the <strong>Submit button</strong> to check for the price for
            the token pair
          </li>
          <li>
            Click on the <strong> Check Button</strong> to check if a token is either an ERC20, ERC721, or ERC1155
            token.
          </li>
        </ul>
      </ul>
    </details>
    <br />

    <div class="input-area">
      <form id="form">
        <label for="tk1">Token Adresss 1</label>
        <input type="text" id="tk1" name="tk1" placeholder="0xF9A2D7E60a3297E513317AD1d7Ce101CC4C6C8F6">

        <label for="tk2">Token Address 2</label>
        <input type="text" id="tk2" name="tk2" placeholder="0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2">

        <span id="price"></span>
      </form>
    </div>
    <div class=" button-area">
      <button class="connect">Connect</button>
      <button class="lookupPrice">Submit</button>
      <button class="checkToken">Check</button>
    </div>
  </div>
</body>

<script>
  const snapId = `local:${window.location.href}`;

  document.querySelector(".lookupPrice").addEventListener("click", lookup);

  const connectButton = document.querySelector('button.connect');
  const lookupButton = document.querySelector('button.lookupPrice');
  const checkTokenButton = document.querySelector('button.checkToken');
  const price = document.querySelector("#price")

  connectButton.addEventListener('click', connect);
  lookupButton.addEventListener('click', lookup);

  // here we get permissions to interact with and install the snap
  async function connect() {
    // todo! check if we're already connected
    await ethereum.request({
      method: 'wallet_enable',
      params: [
        { wallet_snap: { [snapId]: {} } },
      ],
    });
  }

  async function snapRPC(method, args) {
    let response = await ethereum.request({
      method: 'wallet_invokeSnap',
      params: [snapId, { method, args }],
    });

    if ('error' in response) {
      throw Object.assign(
        new Error(
          `An error occurred while executing a snap method\n${[
            '-------- snap context --------',
            ...response.error.stack.split('\n').map(l => `  ${l}`),
            ...(response.error.causes || []).flatMap((cause, i) => [
              "",
              ...([
                ...(!i ? ["  Caused by:"] : []),
                ...cause.stack.split('\n').map(l => `      ${l}`),
              ]),
            ]),
            '-------- snap context --------',
          ].map(l => `      ${l}`).join('\n')}`,
        ),
        { source: response.error },
      );
    }
    return response.result;
  }

  function getTokenInputs() {
    let inputs = [document.querySelector("#tk1").value, document.querySelector("#tk2").value];
    return inputs.filter(Boolean);
  }

  async function lookup() {
    price.innerText = "Loading Price Data...";
    let tokenPair = getTokenInputs();
    if (tokenPair.length === 2) {
      let response = await snapRPC("price_lookup", { tokenPair });
      let priceReport = [
        [response[tokenPair[0]].symbol, response[tokenPair[1]].symbol].join(' / '),
        `  \u2022 Price: ${response[tokenPair[0]].price}`
      ].join("\n");
      price.innerText = priceReport;
    }
  }

  async function checkTokenCompliance() {
    let response = await snapRPC("check_compliance", { erc: 20, address: "0x08BA8CBbefa64Aaf9DF25e57fE3f15eCC277Af74" });
    alert('result from compliance ', response);

    form.addEventListener("submit", (event) => {
      // handle the form data
      event.preventDefault();
      console.log(event.target[0].value);
      console.log(event.target[1].value);
    });
  }
</script>

</html>
